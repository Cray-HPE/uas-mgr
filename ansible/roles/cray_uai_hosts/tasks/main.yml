# cray-uas-mgr localization ansible play
# MIT License
#
# (C) Copyright [2020] Hewlett Packard Enterprise Development LP
#
# Permission is hereby granted, free of charge, to any person obtaining a
# copy of this software and associated documentation files (the "Software"),
# to deal in the Software without restriction, including without limitation
# the rights to use, copy, modify, merge, publish, distribute, sublicense,
# and/or sell copies of the Software, and to permit persons to whom the
# Software is furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included
# in all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
# THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
# OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
# ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
# OTHER DEALINGS IN THE SOFTWARE.
---
- name: Set macvlan bridge facts
  set_fact:
    mac0_list: "{{ mac0_list | default([]) + [ uai_macvlan ] }}"
  loop:
    "{{ groups['uai_hosts'] | sort }}"
  loop_control:
    index_var: cur_host
  run_once: True

- name: Gather river network facts
  set_fact:
    uai_macvlan: "{{ item.subnets | selectattr('label', 'equalto', 'uai_macvlan') | list }}"
    uai_macvlan_network: "{{ item.network }}"
    uai_macvlan_bridge_vlan: "vlan{{ '%03d' | format( item.vlan_id | int ) }}"
  loop: "{{ networks.node_management.blocks.ipv4 | selectattr('label', 'equalto', 'river') | list }}"

- name: Gather mountain network facts
  set_fact:
    uai_macvlan_mtn: "{{ item.subnets | selectattr('label', 'equalto', 'uai_macvlan') | list }}"
  loop: "{{ networks.node_management.blocks.ipv4 | selectattr('label', 'equalto', 'mountain') | list }}"

- name: Set UAI macvlan facts
  set_fact:
    uai_macvlan_bridge_network: "{{ item.network }}"
    uai_macvlan_bridge_gateway: "{{ item.gateway }}"
    uai_macvlan_dhcp_start: "{{ item.dhcp.start }}"
    uai_macvlan_dhcp_end: "{{ item.dhcp.end }}"
    uai_macvlan_bridge_if: "{{ item.macvlan_bridge_if | default( uai_macvlan_bridge_vlan ) }}"
  loop: "{{ uai_macvlan }}"

- name: Set UAI mountain macvlan facts
  set_fact:
    uai_macvlan_mtn_network: "{{ item.network }}"
    uai_macvlan_mtn_gateway: "{{ item.gateway }}"
  loop: "{{ uai_macvlan_mtn }}"
