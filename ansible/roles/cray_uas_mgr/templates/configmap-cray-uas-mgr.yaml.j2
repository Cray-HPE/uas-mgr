# Copyright 2018, Cray Inc. All Rights Reserved.
---
apiVersion: v1
data:
  cray-uas-mgr.yaml: |
    #
    # Copyright 2018, Cray Inc.  All Rights Reserved.
    #
    # Cray User Access Instance Manager Configuration file.
    #
    # This file provides the configuration data for the user access instance
    # manager.
    #
    ---
    # UAS Instance IP/hostname.
    # This section defines the external IP/hostname that UAS instance access
    # will use.
    uas_ips:
{% if gateways is defined %}
{% if gateways.user_gw is defined %}
{% for item in gateways.user_gw %}
      - {{ item }}
{% endfor %}
{% endif %}
{% endif %}

    # UAS Service IP/hostname.
    # This section defines the external IP/hostname that UAS instance services
    # will use.
    uas_svc_ips:
{% if gateways is defined %}
{% if gateways.user_svc_ips is defined %}
{% for item in gateways.user_svc_ips %}
      - {{ item }}
{% endfor %}
{% endif %}
{% endif %}

    # UAS Ports
    # This section defines the ports that the UAS instance services will expose
    # for user access.
    uas_ports:
{% if uas_mgr is defined %}
{% if uas_mgr.uas_ports is defined %}
{% for item in uas_mgr.uas_ports %}
      - {{ item }}
{% endfor %}
{% else %}
      - 30123
{% endif %}
{% endif %}

    # UAS Service Ports
    # This section defines the ports that the UAS instance will expose for shasta
    # services such as WLM and Debugger use. Needs to match port range given
    # for the service being supported, for example, slurm.
    uas_svc_ports:
{% if uas_mgr is defined %}
{% if uas_mgr.uas_svc_ports is defined %}
{% for item in uas_mgr.uas_svc_ports %}
      - {{ item }}
{% endfor %}
{% endif %}
{% endif %}

    # UAS Service Types
    # This section defines the service types that the UAS instance will use for
    # user ssh and UAI service I/O.
    # uas_ssh_type: defines the service type for user ssh access to the UAI.
    # uas_svc_type: defines the service type for UAI service I/O connections.
{% if uas_mgr is defined %}
{% if uas_mgr.uas_ssh_type is defined %}
    uas_ssh_type: "{{ uas_mgr.uas_ssh_type }}"
{% endif %}
{% if uas_mgr.uas_svc_type is defined %}
    uas_svc_type: "{{ uas_mgr.uas_svc_type }}"
{% endif %}
{% endif %}

    # UAS Service Load Balancer Pools
    # This section defines the service load balancer IP pools that the UAS
    # instance will use for user ssh and UAI service I/O.
    # uas_ssh_lb_pool: defines the service load balancer IP pool for user ssh access to the UAI.
    # uas_svc_lb_pool: defines the service load balancer IP for UAI service I/O connections.
{% if uas_mgr is defined %}
{% if uas_mgr.uas_ssh_lb_pool is defined %}
    uas_ssh_lb_pool: "{{ uas_mgr.uas_ssh_lb_pool }}"
{% endif %}
{% if uas_mgr.uas_svc_lb_pool is defined %}
    uas_svc_lb_pool: "{{ uas_mgr.uas_svc_lb_pool }}"
{% endif %}
{% endif %}

    # Volume mounts.
    # This section defines which filesystems, configmaps, and secrets will be volume
    # mounted to the UAS instance.
    #   name: name of the mount
    #   mount_path: absolute path where the UAS instance should mount this volume.
    #   For filesystems, set the following:
    #       host_path: absolute path on the host system of the volume to mount.
    #   For configmaps, set the following:
    #       config_map: the name of the configmap to mount
    #   For secrets, set the following:
    #       secret_name: name of the secret to mount
    volume_mounts:
{% if uas_mgr is defined %}
{% for item in uas_mgr.volume_mounts %}
      - name: {{ item.name }}
        mount_path: {{ item.mount_path }}
{% if item.host_path is defined %}
        host_path: {{ item.host_path }}
{% endif %}
{% if item.config_map is defined %}
        config_map: {{ item.config_map }}
{% endif %}
{% if item.secret_name is defined %}
        secret_name: {{ item.secret_name }}
{% endif %}
{% endfor %}
{% endif %}

    # UAS Images
    # The following list contains the supported images a user may choose for
    # their UAS instance.  Image names must be quoted if they contain special
    # characters such as ':'.
    #
    #   default_image: default image name to use if none are selected.
    #   images:
    #     - 'repo:port/cray-uas-img:latest'
    #
    uas_images:
{% if uas_mgr is defined %}
      default_image: "{{ uas_mgr.uas_images.default_image | default(None, true) }}"
      images:
{% for item in uas_mgr.uas_images.images %}
        - "{{ item }}"
{% endfor %}
{% endif %}
kind: ConfigMap
metadata:
  name: {{ cray_uas_mgr_configmap }}
